# Logowanie

1. Słuchajcie, przechodzimy teraz do bardzo ważnego tematu jakim jest logowanie. Czym jest logowanie? To każdy z Was myślę, że wie, więc jednym zdaniem można to ująć jako: zapisywanie wszelkich zdarzeń zachodzących w aplikacji.
2. Moim zdaniem istnieją dwie rzeczy, bez których nawet prosty projekt, czy Proof of Concept po 3/6 miesiącach nie może wejść na produkcję:
	1. Logi - o czym teraz będziemy o tym rozmawiać
	2. Testy - o czym będziemy rozmawiać później
3. Część z Was może jeszcze pomyśleć o monitoringu, jako o trzecim elemencie niezbędnym - tutaj nie jestem przekonany czy jest to niezbędny element. To zależy też oczywiście od stadium rozwoju aplikacji - jeżeli jest to początek, to moim zdaniem może jeszcze wejść jeszcze bez monitoringu, bo często monitoring oprócz takich fundamentalnych, podstawowych metryk musi też monitorować "specyficzne" metryki dla danego API, które po pierwszych iteracjach dopiero będą znane. Później jak już aplikacja jest bardziej dojrzała to oczywiście monitoring musi być. Natomiast mówiąc o takich niezbędnych elementach - niezależnie od tego w jakim jest stadium, czy to sam początek, czy już coś bardziej rozwiniętego, to jednak logowanie i testy jest must-have. Ja osobiście nie wdrażam nic na produkcję bez tych dwóch rzeczy - nie ma opcji.
4. Dlaczego? Dlatego, że naprawa bugów i debugowanie czegoś bez tych dwóch rzeczy to ISTNY KOSZMAR, zajmujący strasznie dużo czasu. Ja wole sobie tego zaoszczędzić.
5. Teraz porozmawiamy sobie o logowaniu w API. Od razu na wstępie powiem tak: 
	1. Pierwsza sprawa najważniejsza moim zdaniem -  chciałbym na tym zjeździe przekazać Wam najważniejsze punkty - ideę logowania: chciałbym żebyśmy mogli odpowiedzieć sobie na pytanie: KIEDY logować? CO logować? jak POWIĄZAĆ logi? Nie będziemy omawiać tutaj jak zbudowana jest pythonowa biblioteka logging i jak definiować w niej te wszystkie formattery, filtery itd. Nie nie. Chce się skupić na najważniejszych punktach - idei logowania. A to jaką bibliotekę finalnie użyjecie, to będzie to Wasza indywidualna preferencja. Z tym powiązaniem chodzi o to, że każdy log to będzie oddzielny wpis. Biorać pod uwagę fakt, że Wasze API będzie działało na wielu instancjach a zapytań wykonywach będzie wiele, to sami się przekonacie, że ilość logów jest ogromna. Zatem trzecie pytanie dotyczy w sumie jak się połapać w gąszczu tych wszystkich logów. O samym logowaniu można naprawdę pisać i wygłaszać elaboraty. Jak sobie sami spojrzycie np. w dyskusje na Stackoverflow oraz na Reddicie, każdy ma swoje zdanie na ten temat, są różne punkty widzenia. Ja przedstawie Wam tą wiedzę jaką zebrałem na bazie swojego doświadczenia + wzbogaconą o mieszanką wiedzy i doświadczeń innych developerów, czy to w trakcie rozmów czy właśnie analizy dyskusji na różnych forach. Najważniejsze moim zdaniem w logowaniu jest to, żeby Wam pomogło to w pracy - więc jeżeli będziecie uważać, że pewne rzeczy zrobilibyście inaczej i uważacie, że Wam się to lepiej sprawdzi - to jest ok, to to zróbcie.
	2. Druga sprawa - do logowania jest sporo bibliotek, znacznie lepszych niż zbudowany w pythonie moduł `logging`, który ma swoje wady - jedną z nich jest jego troche dziwna konfiguracja, przez co nie jest łatwa. Jest to bardzo stary moduł. Tych bibliotek jest sporo, ale moim zdaniem na największą uwagę zasługuje [logguru](https://github.com/Delgan/loguru) który znacznie upraszcza korzystanie z podstawowego `loggingu` oraz [structlog](https://www.structlog.org/en/stable/why.html), który skupia się na tworzeniu logów w formacie JSON. Niemniej jednak, każdy z nich korzysta pod spodem z pythonowego, podstawowego `logging`, więc warto poznać najpierw tą podstawową bibliotekę. Ja na naszym zjeździe zostanę przy podstawowym pythonowym `logging`-u - nie chce Wam wprowadzać nowych bilbiotek, które są kolejną warstwą nałożoną na podstawowy `logging`. I tak jak mówiłem, chce Wam przekazać ideę logowania - później w trakcie swojej pracy jak już oswoicie się z logowaniem to zdecydujecie, którą ostatecznie bibliotekę chcecie wykorzystywać.
	4. Trzecia sprawa - w sieci znajdziecie wiele różnych implementacji jak logować pewne zdarzenia. Bardzo często spotykanym patternem w temacie logowania jest decorator i przykładów decoratorów znajdziecie wiele - np. [ten](https://ankitbko.github.io/blog/2021/04/logging-in-python/). On jest wielki i troche brzydki - na pewno można go zapisać lepiej. Nie mniej jednak one będą tak wyglądać - jeżeli będziecie chcieli zrobić decorator, który będzie służył Wam zawsze i wszędzie, aby logował Wam to co chcecie, to będzie on skomplikowany. Ja Wam powiem z własnego doświadczenia, że... bawiłem się takimi decoratorami, które mogłyby logować wszystko co chce... i w moim przypadku się to nie sprawdza. Do logowania prostych funkcji tak, ale z bardziej skomplikowaną logiką już nie. Zawsze powstawał mi taki kolos, który ciężko było utrzymać i rozwijać gdy pojawiały się jakieś funkcje, które wyjątkowo inaczej musiałem zlogować. Ja porzuciłem ten pomysł i robie to prosto... po prostu dodając logowanie jako kolejne linijki kodu. Jeżeli natomiast Wy macie lepsze doświadczenia z tym związane i uważacie decoratory za fajny pattern do użycia w logowaniu i Wam się sprawdza... to jak najbardziej z tego korzystajcie. Natomiast ja nie będę ich używał na naszym zjeździe - pójdę w prostotę.


Ok to zacznijmy od początku:

1. Kiedy warto logować? 

Generalnie sprawa z pytaniem KIEDY warto logować jest stosunkowo prosta:

1. Na początku wywołania funkcji - aby mieć informacje zwrotną, że faktycznie rozpoczęło się jej wykonanie
2. Oraz na końcu wywołania funkcji - aby mieć informację zwrotną, że faktycznie funkcja zakończyła się. Z logowaniem na końcu funkcji jest jeszcze jedna istotna właściwość - oznacza to, że funkcja wykonała się prawidłowo. 
3. Natomiast jeżeli istnieje jakiś element w środku wywołania funkcji, który naszym zdaniem jest istotny i warto wiedzieć, że coś się wtedy zadziało, to także warto to logować. 

Dodajmy sobie pierwsze logi do naszego API. Wróćmy do `main.py` i spójrzmy jak wygląda wywołanie kodu.

Mamy wywołanie `app = FastAPI()` - czy tutaj można dodać logi? Można. Ale zajmiemy się tym na końcu.

Dalej mamy wywołanie naszego modelu `model = CreditScoringModel(path=Path("models/classifier.pkl"))`.  Czy mamy tutaj logi? Nie mamy. Czy według nas jest to istotna rzecz, żeby zlogować? Moim zdaniem tak. Model w API to podstawowy komponent działania naszego modelu, jeżeli nie moglibyśmy go załadować, to chcielibyśmy wiedzieć dlaczego.

W takim razie dodajmy sobie logowanie do naszego modelu.
Zaimportujmy sobie moduł `logging`

```python
import logging
```

I do ładowania modelu dodajmy sobie logowanie:

Tak jak wspominałem: ważny jest początek i koniec. Zatem:

```python
logging.info("Loading Credit Scoring Model")
```

Na początku wywołania funkcji. Oraz:

```python
logging.info("Successfully loaded Credit Scoring Model")
```
Na końcu wywołania funkcji. Jeżeli logowania dojdzie do tego momentu, mamy również gwarancję tego, że bez problemu udało się nam załadować model. 

Dodatkowo wspomniałem o tym, że istotne jest również zastanowienie się czy w środku wywołania funkcji, innymi słowy pomiędzy startem logowania i końcem logowania jest coś istotnego. W tym przypadku oczywiście, że jest - sam proces załadowania obiektu. Co się może tutaj zdarzyć? Oczywiście fakt taki, że dany obiekt nie istnieje i to jest ten istotny element, o którym warto byłoby wiedzieć. Zatem dodajmy sobie

```python

```


Pytanie: Dlaczego zwykłe printy nie zadziałają?
Odp: 1. Formatowanie będzie kiepskie (np. traceback) 2. Printy piszą do XXX i nie zawsze może być obsłużone 

Pytanie: Co z `logging.getLogger(__name__)`
Jeżeli ktoś z Was już korzystał z `logging`-u wcześniej, to na pewno zna kod:

```python
logger = logging.getLogger(__name__)
```
Natomiast nie bedziemy z niego korzystać, tak jak mówiłem, nie chce omawiać dokładnie jak działa pythnowy moduł `logging`, a skupić się na samej idei. 


https://guicommits.com/how-to-log-in-python-like-a-pro/


2. Co warto logować?



3. Jak powiązać logi?